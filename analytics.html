<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AquaFlow - Sales Analytics</title>
    <link rel="manifest" href="/manifest-owner.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/owner-icon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            color: #111827;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 0;
        }
        .logo { font-size: 1.75rem; flex-shrink: 0; }
        h1 { font-size: 1.125rem; font-weight: bold; line-height: 1.2; }
        .subtitle { font-size: 0.75rem; opacity: 0.9; margin-top: 0.125rem; }
        .header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; align-items: center; }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-header:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .btn-header:active { transform: scale(0.95); }
        .btn-header.refreshing { animation: spin 0.6s linear infinite; opacity: 0.7; cursor: wait; }

        .btn-export-header {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            height: 2.5rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-export-header:hover { background: rgba(255,255,255,0.3); }

        .last-updated { font-size: 0.6875rem; opacity: 0.8; display: none; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @media (min-width: 640px) {
            .header { padding: 1.5rem; }
            .logo { font-size: 2rem; }
            h1 { font-size: 1.5rem; }
            .subtitle { font-size: 0.875rem; margin-top: 0.25rem; }
            .btn-header { width: 2.75rem; height: 2.75rem; }
            .last-updated { display: inline; }
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metric-card {
            background: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-label { font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem; }
        .metric-value { font-size: 1.75rem; font-weight: bold; color: #111827; line-height: 1.2; }
        .metric-sub { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }
        .metric-change { font-size: 0.8125rem; margin-top: 0.25rem; }
        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }

        /* Charts */
        .chart-card {
            background: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.25rem;
        }
        .chart-title { font-size: 1rem; font-weight: 600; color: #111827; margin-bottom: 1rem; }
        .chart-container { position: relative; height: 260px; }

        /* Table */
        .table-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 1.25rem;
        }
        .table-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .table-title { font-size: 1rem; font-weight: 600; color: #111827; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #f9fafb;
            padding: 0.625rem 1rem;
            text-align: left;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        td {
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #fafafa; }
        .growth-pos { color: #10b981; font-weight: 600; }
        .growth-neg { color: #ef4444; font-weight: 600; }

        .spinner {
            display: inline-block;
            width: 1.75rem; height: 1.75rem;
            border: 3px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        .loading { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }

        @media (max-width: 640px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-container { height: 220px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <div class="header-title">
            <span class="logo">üíß</span>
            <div>
                <h1>Sales Analytics</h1>
                <p class="subtitle">AquaFlow Business Intelligence</p>
            </div>
        </div>
        <div class="header-actions">
            <span class="last-updated" id="lastUpdated">Just now</span>
            <button class="btn-export-header" id="exportBtn">üì• CSV</button>
            <button class="btn-header" id="refreshBtn" title="Refresh">üîÑ</button>
            <button class="btn-header" onclick="window.location.href='owner-dashboard.html'" title="Back">‚Üê</button>
        </div>
    </div>
</div>

<div class="container">

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">All-Time Revenue</div>
            <div class="metric-value" id="totalRevenue">‚Äî</div>
            <div class="metric-sub" id="totalGallons"></div>
        </div>
        <div class="metric-card">
            <div class="metric-label">This Month's Revenue</div>
            <div class="metric-value" id="monthRevenue">‚Äî</div>
            <div class="metric-change" id="monthChange"></div>
        </div>
        <div class="metric-card">
            <div class="metric-label">This Year's Revenue</div>
            <div class="metric-value" id="yearRevenue">‚Äî</div>
            <div class="metric-sub" id="yearGallons"></div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Order Value</div>
            <div class="metric-value" id="avgOrder">‚Äî</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Orders</div>
            <div class="metric-value" id="totalOrders">‚Äî</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Gallons Sold</div>
            <div class="metric-value" id="totalGallonsStat">‚Äî</div>
        </div>
    </div>

    <!-- Monthly Revenue Chart -->
    <div class="chart-card">
        <div class="chart-title" id="monthlyChartTitle">Monthly Revenue</div>
        <div class="chart-container">
            <canvas id="monthlyRevenueChart"></canvas>
        </div>
    </div>

    <!-- Customer Type + Payment Method -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; margin-bottom: 1.25rem;">
        <div class="chart-card" style="margin-bottom: 0;">
            <div class="chart-title">Revenue by Customer Type</div>
            <div class="chart-container" style="height: 220px;">
                <canvas id="customerTypeChart"></canvas>
            </div>
        </div>
        <div class="chart-card" style="margin-bottom: 0;">
            <div class="chart-title">Payment Method Split</div>
            <div class="chart-container" style="height: 220px;">
                <canvas id="paymentMethodChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Breakdown Table -->
    <div class="table-card">
        <div class="table-header">
            <div class="table-title">üìÖ Monthly Breakdown</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Orders</th>
                        <th>Gallons</th>
                        <th>Revenue</th>
                        <th>Avg/Order</th>
                        <th>vs Prev</th>
                    </tr>
                </thead>
                <tbody id="monthlyTableBody">
                    <tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const SUPABASE_URL = 'https://objfqhffofsrttjxswkx.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8kUVR1zO703wEgv1je_wtQ_88YK988G';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allOrders = [];
    let charts = {};
    const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    async function loadOrders() {
        const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: true });
        if (error) { console.error(error); return; }
        allOrders = data || [];
        renderAll();
    }

    function renderAll() {
        calculateMetrics();
        renderMonthlyChart();
        renderCustomerTypeChart();
        renderPaymentMethodChart();
        renderMonthlyTable();
    }

    function calculateMetrics() {
        const now = new Date();
        const curYear = now.getFullYear(), curMonth = now.getMonth();
        const paid = allOrders.filter(o => o.payment_status === 'paid');

        const totalRev  = paid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);
        const totalGal  = paid.reduce((s, o) => s + parseInt(o.quantity || 0), 0);

        const monthPaid = paid.filter(o => {
            const d = new Date(o.updated_at || o.created_at);
            return d.getFullYear() === curYear && d.getMonth() === curMonth;
        });
        const monthRev = monthPaid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);

        const lastMonth = curMonth === 0 ? 11 : curMonth - 1;
        const lastYear  = curMonth === 0 ? curYear - 1 : curYear;
        const lastPaid  = paid.filter(o => {
            const d = new Date(o.updated_at || o.created_at);
            return d.getFullYear() === lastYear && d.getMonth() === lastMonth;
        });
        const lastRev = lastPaid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);

        const yearPaid = paid.filter(o => new Date(o.updated_at || o.created_at).getFullYear() === curYear);
        const yearRev  = yearPaid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);
        const yearGal  = yearPaid.reduce((s, o) => s + parseInt(o.quantity || 0), 0);

        const avg = paid.length > 0 ? totalRev / paid.length : 0;

        document.getElementById('totalRevenue').textContent  = '‚Ç±' + totalRev.toLocaleString('en-US', {maximumFractionDigits: 0});
        document.getElementById('totalGallons').textContent  = totalGal.toLocaleString() + ' gal total';
        document.getElementById('totalGallonsStat').textContent = totalGal.toLocaleString() + ' gal';
        document.getElementById('monthRevenue').textContent  = '‚Ç±' + monthRev.toLocaleString('en-US', {maximumFractionDigits: 0});
        document.getElementById('yearRevenue').textContent   = '‚Ç±' + yearRev.toLocaleString('en-US', {maximumFractionDigits: 0});
        document.getElementById('yearGallons').textContent   = yearGal.toLocaleString() + ' gal this year';
        document.getElementById('avgOrder').textContent      = '‚Ç±' + avg.toLocaleString('en-US', {maximumFractionDigits: 0});
        document.getElementById('totalOrders').textContent   = allOrders.length;

        const changeEl = document.getElementById('monthChange');
        if (lastRev > 0) {
            const pct = ((monthRev - lastRev) / lastRev * 100).toFixed(1);
            changeEl.textContent = (pct > 0 ? '+' : '') + pct + '% vs last month';
            changeEl.className = 'metric-change ' + (pct >= 0 ? 'positive' : 'negative');
        } else {
            changeEl.textContent = '';
        }
    }

    function renderMonthlyChart() {
        const curYear = new Date().getFullYear();
        document.getElementById('monthlyChartTitle').textContent = `Monthly Revenue ‚Äî ${curYear}`;

        const monthlyData = Array(12).fill(0);
        allOrders.filter(o => o.payment_status === 'paid').forEach(o => {
            const d = new Date(o.updated_at || o.created_at);
            if (d.getFullYear() === curYear) monthlyData[d.getMonth()] += parseFloat(o.total_amount || 0);
        });

        if (charts.monthly) charts.monthly.destroy();
        charts.monthly = new Chart(document.getElementById('monthlyRevenueChart'), {
            type: 'bar',
            data: {
                labels: MONTH_NAMES,
                datasets: [{ label: 'Revenue (‚Ç±)', data: monthlyData, backgroundColor: 'rgba(102,126,234,0.8)', borderColor: 'rgba(102,126,234,1)', borderWidth: 1 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: v => '‚Ç±' + v.toLocaleString() } } }
            }
        });
    }

    function renderCustomerTypeChart() {
        const paid = allOrders.filter(o => o.payment_status === 'paid');
        const data = { household: 0, reseller: 0, company: 0 };
        paid.forEach(o => { data[o.customer_type || 'household'] += parseFloat(o.total_amount || 0); });

        if (charts.customerType) charts.customerType.destroy();
        charts.customerType = new Chart(document.getElementById('customerTypeChart'), {
            type: 'doughnut',
            data: {
                labels: ['üè† Household', 'üè™ Reseller', 'üè¢ Company'],
                datasets: [{ data: [data.household, data.reseller, data.company], backgroundColor: ['rgba(59,130,246,0.8)', 'rgba(251,191,36,0.8)', 'rgba(139,92,246,0.8)'], borderWidth: 2, borderColor: '#fff' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderPaymentMethodChart() {
        const paid = allOrders.filter(o => o.payment_status === 'paid');
        const data = { cod: 0, gcash: 0, maya: 0 };
        paid.forEach(o => { const m = o.payment_method || 'cod'; data[m] = (data[m] || 0) + parseFloat(o.total_amount || 0); });

        if (charts.payment) charts.payment.destroy();
        charts.payment = new Chart(document.getElementById('paymentMethodChart'), {
            type: 'pie',
            data: {
                labels: ['üíµ COD', 'üì± GCash', 'üì± Maya'],
                datasets: [{ data: [data.cod, data.gcash, data.maya], backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(59,130,246,0.8)', 'rgba(245,158,11,0.8)'], borderWidth: 2, borderColor: '#fff' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderMonthlyTable() {
        const curYear = new Date().getFullYear();
        const tbody = document.getElementById('monthlyTableBody');

        const stats = MONTH_NAMES.map((name, i) => {
            const monthOrders = allOrders.filter(o => {
                const d = new Date(o.created_at);
                return d.getFullYear() === curYear && d.getMonth() === i;
            });
            const paid = monthOrders.filter(o => o.payment_status === 'paid');
            const rev  = paid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);
            const gal  = paid.reduce((s, o) => s + parseInt(o.quantity || 0), 0);
            const avg  = paid.length > 0 ? rev / paid.length : 0;
            return { name, orders: monthOrders.length, paid: paid.length, rev, gal, avg };
        });

        // Only show months with orders, newest first
        const rows = stats
            .map((s, i) => ({ ...s, index: i }))
            .filter(s => s.orders > 0)
            .reverse();

        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üìä</div><p>No data yet</p></div></td></tr>`;
            return;
        }

        tbody.innerHTML = rows.map((s, idx) => {
            const prev = rows[idx + 1];
            let growth = '‚Äî';
            let growthClass = '';
            if (prev && prev.rev > 0) {
                const pct = ((s.rev - prev.rev) / prev.rev * 100).toFixed(1);
                growth = (pct > 0 ? '+' : '') + pct + '%';
                growthClass = pct >= 0 ? 'growth-pos' : 'growth-neg';
            }
            return `
                <tr>
                    <td><strong>${s.name} ${curYear}</strong></td>
                    <td>${s.orders}</td>
                    <td>${s.gal.toLocaleString()} gal</td>
                    <td><strong>‚Ç±${s.rev.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong></td>
                    <td>‚Ç±${s.avg.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="${growthClass}">${growth}</td>
                </tr>`;
        }).join('');
    }

    function exportCSV() {
        const curYear = new Date().getFullYear();
        let csv = 'Month,Total Orders,Gallons,Revenue,Avg Order\n';
        MONTH_NAMES.forEach((name, i) => {
            const mo = allOrders.filter(o => { const d = new Date(o.created_at); return d.getFullYear() === curYear && d.getMonth() === i; });
            const paid = mo.filter(o => o.payment_status === 'paid');
            const rev = paid.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);
            const gal = paid.reduce((s, o) => s + parseInt(o.quantity || 0), 0);
            if (mo.length > 0) csv += `${name} ${curYear},${mo.length},${gal},${rev.toFixed(2)},${mo.length > 0 ? (rev/mo.length).toFixed(2) : 0}\n`;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = `AquaFlow_Analytics_${curYear}.csv`;
        a.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();

        document.getElementById('refreshBtn').addEventListener('click', function() {
            this.classList.add('refreshing');
            this.disabled = true;
            loadOrders().then(() => {
                setTimeout(() => { this.classList.remove('refreshing'); this.disabled = false; }, 800);
            });
        });

        document.getElementById('exportBtn').addEventListener('click', exportCSV);
    });
</script>
</body>
</html>
